(function(){"use strict";var e={7494:function(e,n,t){var a=t(8764);window.Buffer=a.Buffer;var o=t(9963),i=t(6252);const s=(0,i._)("div",{id:"custom-css",style:{display:"none"}},null,-1);function r(e,n,t,a,o,r){const u=(0,i.up)("DanmakuItem"),c=(0,i.up)("Live");return(0,i.wg)(),(0,i.iD)(i.HY,null,[s,e.errMsg?((0,i.wg)(),(0,i.j4)(u,{key:0,type:"info",message:e.errMsg},null,8,["message"])):e.ready?((0,i.wg)(),(0,i.j4)(c,(0,i.dG)({key:1},e.props,{"live-ws-options":e.liveWsOptions}),null,16,["live-ws-options"])):(0,i.kq)("",!0)],64)}t(7658);var u=t(2262),c=t(8718),l=t.n(c),d=t(6604),m=t.n(d),f=t(7563);const p={auth:"normal",akId:"",akSecret:"",appId:"",code:"",room:"",cookie:"",cors:"false",face:"true",display:"bottom",stay:"",limit:"",giftComb:"",giftPin:"",delay:"",blockUID:"",debug:"",customCss:""};Object.freeze(p);const g=["room","stay","giftComb","limit","giftPin","delay","appId"];Object.freeze(g);const v=new Set(g);Object.freeze(v);const h=e=>v.has(e),w={};Object.freeze(w);const y=m()(p,((e,n)=>v.has(n)?Number:String));Object.freeze(y);const k={auth:[{value:"normal",text:"普通模式"},{value:"open",text:"开放平台"}],cors:[{value:"false",text:"关闭（所有跨域请求将依赖反代服务）"},{value:"true",text:"开启（请阅读右侧说明）"}],face:[{value:"true",text:"显示"},{value:"false",text:"不显示"}],display:[{value:"bottom",text:"自底部"},{value:"top",text:"从顶部"}]};Object.freeze(k);const b=e=>m()(l()({...p,...(0,f.parse)(e)},Object.keys(p)),((e,n)=>h(n)?e&&parseInt(e)||w[n]||0:n in k?k[n].some((({value:n})=>n===e))?e:p[n]:e||p[n]));let _=!0;const O=e=>_=e,S=(e,n={})=>fetch(e,{referrer:"",referrerPolicy:"no-referrer",...n}),D=(e,n)=>S(e,n).then((e=>e.json())),L=(e,n)=>fetch("https://blc-proxy.lolicon.app",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,...l()(n,["method","headers","body"])}),referrerPolicy:"origin"}),I=(e,n)=>L(e,n).then((e=>e.json())),T=(e,n)=>_?D(e,n):I(e,n);t(1439),t(7585),t(5315);var j=t(2568),x=t.n(j);async function N(e,n,t){const a=parseInt(Date.now()/1e3+""),o=parseInt(1e5*Math.random()+"")+a,i={"x-bili-accesskeyid":n,"x-bili-content-md5":x()(e),"x-bili-signature-method":"HMAC-SHA256","x-bili-signature-nonce":o+"","x-bili-signature-version":"1.0","x-bili-timestamp":a},s=[];for(const u in i)s.push(`${u}:${i[u]}`);const r=await E(t,s.join("\n"));return{Accept:"application/json","Content-Type":"application/json",...i,Authorization:r}}async function E(e,n){const t=new TextEncoder,a=await window.crypto.subtle.importKey("raw",t.encode(e),{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]),o=await window.crypto.subtle.sign("HMAC",a,t.encode(n));return Array.from(new Uint8Array(o)).map((e=>e.toString(16).padStart(2,"0"))).join("")}const H="https://live-open.biliapi.com/v2/app/start",P="https://live-open.biliapi.com/v2/app/end";async function A(e,n,t,a){const o=JSON.stringify(n),i=await N(o,t,a);return T(e,{method:"POST",headers:i,body:o})}async function C(e,n,t,a){const{code:o,message:i,data:s}=await A(H,{code:a,app_id:t},e,n);if(0!==o)throw new Error(i);const r=s.game_info.game_id;return r&&A(P,{app_id:t,game_id:s.game_info.game_id},e,n).catch(console.error),s}const F={id:"live"};function M(e,n,t,a,o,s){const r=(0,i.up)("danmaku-list");return(0,i.wg)(),(0,i.iD)("div",F,[a.props.giftPin?((0,i.wg)(),(0,i.j4)(r,(0,i.dG)({key:0,ref:"giftPinList"},a.props,{"gift-show-face":a.showFace,"is-gift-list":!0}),null,16,["gift-show-face"])):(0,i.kq)("",!0),(0,i.Wm)(r,(0,i.dG)({ref:"danmakuList"},a.props),null,16)])}var $=t(4171),R=t(7419),z=t(3281);const G=e=>{const n=(0,R.length)(e),t=new Uint8Array(n);return(0,R.decode)(e,t,0),t},B=new z.Type("UserInfo").add(new z.Field("face",4,"string")),U=new z.Type("DanmakuMessageV2").add(B).add(new z.Field("user",20,"UserInfo")),J=e=>{const n=G(e);return U.decode(n)},V={key:0,class:"danmaku-list-pinned",ref:"danmakuListRef"},q={class:"danmaku-list hidden"},K={class:"danmaku-list absolute",ref:"giftListRef"},W={key:1,class:"danmaku-list",ref:"danmakuListRef"},Y={key:0,class:"danmaku-list-placeholder"};function Z(e,n,t,a,o,s){const r=(0,i.up)("danmaku-item");return t.isGiftList?((0,i.wg)(),(0,i.iD)("div",V,[(0,i._)("div",q,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(e.giftPin,(e=>((0,i.wg)(),(0,i.j4)(r,{key:e,"show-face":t.giftShowFace,type:"gift",uname:"某人",giftName:"礼物",num:e},null,8,["show-face","num"])))),128))]),(0,i._)("div",K,[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.danmakuList,(e=>((0,i.wg)(),(0,i.j4)(r,(0,i.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:n=>e.el=n}),null,16,["hidden"])))),128))],512)],512)):((0,i.wg)(),(0,i.iD)("div",W,["bottom"===e.display?((0,i.wg)(),(0,i.iD)("div",Y)):(0,i.kq)("",!0),((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(a.danmakuList,(e=>((0,i.wg)(),(0,i.j4)(r,(0,i.dG)({key:e.key},e.props,{hidden:e.hidden,ref_for:!0,ref:n=>e.el=n}),null,16,["hidden"])))),128))],512))}var X=t(2404),Q=t.n(X),ee=t(7632),ne=t(928),te=t.n(ne),ae=t(3609);const oe=(e,n)=>new Promise(((t,a)=>{let o=0;const i=new XMLHttpRequest,s=setTimeout((()=>{i.abort()}),1e4),r=n?setTimeout((()=>{0===o&&i.abort()}),n):null;i.open("GET",e,!0),i.onprogress=e=>{e.lengthComputable&&(o=e.loaded/e.total)},i.onload=()=>{clearTimeout(r),clearTimeout(s),t(e)},i.onerror=a,i.onabort=a,i.send()}));var ie=async e=>{for(const[n,t]of e){const e=await oe(n,t).catch((()=>{console.warn("Timeout",n)}));if(e)return e}return e[0][0]};window.localStorage.removeItem("blc-face");const se=new ae.z({max:500,ttl:6e5,updateAgeOnGet:!0}),re=e=>{const n=ue(e);return n?[[n,2e3],[e,5e3]]:[[e,0]]},ue=e=>{if(!e.endsWith(".gif")&&!e.includes("noface"))return e.replace(/(\.[^./]+$)/,"$1_48x48$1")},ce=async(e,n)=>{const t=e||te()(n.split("/"));if(se.has(t))return se.get(t);const a=re(n.replace(/^http:/,"https:")),o=ie(a);se.set(t,o);const i=await o;return se.set(t,i),i};var le=t(3577);const de=["src"],me={key:1,class:"danmaku-content"},fe={class:"danmaku-message"},pe={key:2,class:"danmaku-content"},ge=(0,i._)("span",{class:"danmaku-message"},"感谢 ",-1),ve={class:"danmaku-author-name"},he=(0,i._)("span",{class:"danmaku-message"}," 赠送的 ",-1),we={class:"danmaku-gift-name"},ye=(0,i._)("span",{class:"danmaku-message"}," × ",-1),ke={class:"danmaku-gift-num"},be={key:3,class:"danmaku-content"},_e=(0,i._)("span",{class:"danmaku-message"},"感谢 ",-1),Oe={class:"danmaku-author-name"},Se={class:"danmaku-message"},De={key:4,class:"danmaku-content"},Le={class:"danmaku-message info"};function Ie(e,n,t,a,o,s){return(0,i.wg)(),(0,i.iD)("div",{class:(0,le.C_)(["danmaku-item",{hidden:a.isHidden}])},[t.showFace&&t.face?((0,i.wg)(),(0,i.iD)("img",{key:0,class:"danmaku-author-face",src:t.face},null,8,de)):(0,i.kq)("",!0),"message"===t.type?((0,i.wg)(),(0,i.iD)("div",me,[(0,i._)("span",{class:(0,le.C_)(["danmaku-author-name with-colon",{anchor:t.isAnchor,owner:t.isOwner}])},(0,le.zw)(t.uname),3),(0,i._)("span",fe,(0,le.zw)(t.message),1)])):"gift"===t.type?((0,i.wg)(),(0,i.iD)("div",pe,[ge,(0,i._)("span",ve,(0,le.zw)(t.uname),1),he,(0,i._)("span",we,(0,le.zw)(t.giftName),1),t.num?((0,i.wg)(),(0,i.iD)(i.HY,{key:0},[ye,(0,i._)("span",ke,(0,le.zw)(t.num),1)],64)):(0,i.kq)("",!0)])):"sc"===t.type?((0,i.wg)(),(0,i.iD)("div",be,[_e,(0,i._)("span",Oe,(0,le.zw)(t.uname),1),(0,i._)("span",Se," 的SC："+(0,le.zw)(t.message),1)])):"info"===t.type?((0,i.wg)(),(0,i.iD)("div",De,[(0,i._)("span",Le,(0,le.zw)(t.message),1)])):(0,i.kq)("",!0)],2)}var Te={props:{type:{type:String,default:"message"},showFace:Boolean,face:String,uid:Number,uname:String,message:String,isAnchor:Boolean,isOwner:Boolean,giftName:String,num:Number,stay:Number,hidden:Boolean},setup(e){const n=(0,u.iH)(!1),t=(0,u.iH)(!1);if(e.stay){const a=setTimeout((()=>{n.value=!0,"info"===e.type&&setTimeout((()=>t.value=!0),800)}),e.stay);(0,i.Jd)((()=>clearTimeout(a)))}const a=(0,i.Fl)((()=>e.hidden||n.value));return{...(0,u.BK)(e),isHidden:a,needRemoved:t}}},je=t(3744);const xe=(0,je.Z)(Te,[["render",Ie]]);var Ne=xe,Ee={components:{DanmakuItem:Ne},props:{...y,isGiftList:Boolean,giftShowFace:Boolean},setup(e){let n=!0;(0,i.Jd)((()=>n=!1));const t=(0,u.iH)([]),a=(0,u.iH)(null),o=(0,u.iH)(null);(0,i.bv)((()=>{const e=a.value.getBoundingClientRect().top-5,n=()=>{const n=t.value.findIndex((n=>{var t,a,o,i;const{top:s=e,height:r=0}=null!==(t=null===(a=n.el)||void 0===a||null===(o=a.$el)||void 0===o?void 0:o.getBoundingClientRect())&&void 0!==t?t:{};return s<e&&(n.hidden=!0),s+r>e&&!(null!==(i=n.el)&&void 0!==i&&i.needRemoved)}));n>0&&t.value.splice(0,n)},o=setInterval(n,100);(0,i.Jd)((()=>clearInterval(o)))}));const s=()=>{const n=(0,u.SU)(e.isGiftList?o:a);n&&(n.scrollTop=n.scrollHeight)};e.isGiftList||((0,i.bv)((()=>window.addEventListener("resize",s))),(0,i.Jd)((()=>window.removeEventListener("resize",s))));const r=[],c=()=>{let e=200;const{length:a}=r;a>0&&(e=Math.min(e,1e3/a),t.value.push(r.shift()),(0,i.Y3)(s)),n&&setTimeout(c,e)};c();const l=async n=>{n.showFace&&n.face&&(n.face=await ce(n.uid,n.face)),n.stay=n.stay||("bottom"===e.display?e.stay:0),r.push({props:n,key:(0,ee.Z)(),el:null,hidden:!1})},d=[];if(e.limit){const n=setInterval((()=>{let n=d.splice(0);n.length&&(n.length>e.limit&&(n=Q()(Object.keys(n),e.limit).sort().map((e=>n[e]))),n.forEach((e=>l(e))))}),1e3);(0,i.Jd)((()=>clearInterval(n)))}const m=e=>d.push(e);return{...(0,u.BK)(e),danmakuList:t,danmakuListRef:a,giftListRef:o,addDanmaku:l,addSpeedLimitDanmaku:m}}};const He=(0,je.Z)(Ee,[["render",Z]]);var Pe=He,Ae={components:{DanmakuList:Pe},props:{...y,anchor:Number,liveWsOptions:Object},setup(e){const n=(0,u.iH)(null),t=(0,u.iH)(null),a=new Map,o=(0,i.Fl)((()=>"false"!==e.face)),s=(0,i.Fl)((()=>new Set(e.blockUID.split(/,|\|/).map((e=>e.trim()))))),r=e=>s.value.has(String(e));let c=[];const l=n=>{t.value.addDanmaku({type:"info",message:n,stay:e.stay||5e3})},d=n=>{e.limit?t.value.addSpeedLimitDanmaku(n):t.value.addDanmaku(n)};return(0,i.bv)((()=>{console.log("正在连接直播弹幕服务器",e.room);const s=new $.KeepLiveWS(e.room,e.liveWsOptions||{protover:3,uid:0});s.interval=1e3,(0,i.Jd)((()=>s.close())),s.on("open",(()=>{s.closed||(console.log("已连接直播弹幕服务器"),l("已连接直播弹幕服务器"))})),s.on("live",(()=>{s.closed||(console.log("已连接直播间",e.room),l(`已连接直播间 ${e.room}`))})),s.on("close",(()=>{if(s.closed)return;console.log("连接已断开"),l("连接已断开");const e=Date.now();c=c.filter((n=>e-n<1e4)),c.push(e),c.length>=3&&(console.log("连接失败过于频繁，停止重连"),l("连接失败过于频繁，停止重连"),s.close())}));const u=e.giftPin?n:t;s.on("SEND_GIFT",(({data:e})=>{m(e)})),s.on("LIVE_OPEN_PLATFORM_SEND_GIFT",(({data:{uid:e,uname:n,gift_name:t,gift_num:a,uface:o}})=>{m({uid:e,uname:n,giftName:t,num:a,face:o})}));const m=({uid:n,uname:t,giftName:i,num:s,face:c})=>{if(r(n))console.log(`屏蔽了来自[${t}]的礼物：${i}*${s}`);else if(e.giftComb){const r=`${n}-${i}`,l=a.get(r);l?a.set(r,{...l,num:l.num+s}):(a.set(r,{type:"gift",showFace:o.value,uid:n,uname:t,giftName:i,num:s,face:c}),setTimeout((()=>{u.value.addDanmaku(a.get(r)),a.delete(r)}),e.giftComb))}else u.value.addDanmaku({type:"gift",showFace:o.value,uid:n,uname:t,giftName:i,num:s,face:c})};s.on("DANMU_MSG",(({info:[,e,[n,t,a]],dm_v2:o})=>{f({uid:n,uname:t,message:e,isOwner:a,dmV2:o})})),s.on("LIVE_OPEN_PLATFORM_DM",(({data:{uid:e,uname:n,msg:t,uface:a}})=>{f({uid:e,uname:n,message:t,face:a})}));const f=({uid:n,uname:t,message:a,isOwner:i,dmV2:s,face:u})=>{if(r(n))return void console.log(`屏蔽了来自[${t}]的弹幕：${a}`);const c={type:"message",showFace:o.value,uid:n,uname:t,message:a,isAnchor:n===e.anchor,isOwner:!!i,face:u};if(s)try{const{user:{face:e}}=J(s);c.face=e}catch(l){console.error("[decode dmV2 error]",l)}e.delay>0?setTimeout((()=>d(c)),1e3*e.delay):d(c)};s.on("SUPER_CHAT_MESSAGE",(({data:{uid:e,user_info:{uname:n,face:t},message:a}})=>{p({uid:e,uname:n,message:a,face:t})})),s.on("LIVE_OPEN_PLATFORM_SUPER_CHAT",(({data:{uid:e,uname:n,message:t,uface:a}})=>{p({uid:e,uname:n,message:t,face:a})}));const p=({uid:e,uname:n,message:t,face:a})=>{u.value.addDanmaku({type:"sc",showFace:o.value,uid:e,uname:n,message:t,face:a})},g={1:"总督",2:"提督",3:"舰长"};s.on("GUARD_BUY",(({data:{uid:e,username:n,gift_name:t,num:a}})=>{v({uid:e,uname:n,giftName:t,num:a})})),s.on("USER_TOAST_MSG",(({data:{uid:e,username:n,role_name:t,num:a,unit:o}})=>{v({uid:e,uname:n,giftName:t,num:a,unit:o})})),s.on("LIVE_OPEN_PLATFORM_GUARD",(({data:{user_info:{uid:e,uname:n,uface:t},guard_level:a,guard_num:o,guard_unit:i}})=>{v({uid:e,uname:n,giftName:g[a],num:o,unit:i,face:t})}));const v=({uid:e,uname:n,giftName:t,num:a,unit:i,face:s})=>{u.value.addDanmaku({type:"gift",showFace:o.value,uid:e,uname:n,giftName:i?`${a}个${i}${t}`:t,num:i?0:a,face:s})}})),{props:e,showFace:o,giftPinList:n,danmakuList:t}}};const Ce=(0,je.Z)(Ae,[["render",M]]);var Fe=Ce,Me=(0,i.aZ)({components:{Live:Fe,DanmakuItem:Ne},setup(){var e;const n=()=>window.location.reload();window.addEventListener("hashchange",n),(0,i.Jd)((()=>window.removeEventListener("hashchange",n)));const t=(0,u.qj)(b(window.location.hash)),a=(0,u.XI)(),o=null===(e=t.customCss)||void 0===e?void 0:e.trim();o&&(0,i.bv)((()=>{var e;const n=document.createElement("style");n.innerHTML=o,null===(e=document.getElementById("custom-css"))||void 0===e||e.appendChild(n)}));const s="true"===t.cors;O(s);const r=(0,u.iH)(!1),c=(0,u.iH)("");return"open"===t.auth?C(t.akId,t.akSecret,parseInt(t.appId),t.code).then((e=>{t.room=e.anchor_info.room_id,t.anchor=e.anchor_info.uid,a.value={address:e.websocket_info.wss_link[0],authBody:JSON.parse(e.websocket_info.auth_body)},r.value=!0})).catch((e=>{let n="开放平台开启失败";s&&(n+="，请检查是否正确禁用了浏览器的 web security 以允许直接跨域"),n+=`\n${e}`,c.value=n})):(async()=>{const e=[],n=T(`https://api.live.bilibili.com/room/v1/Room/room_init?id=${t.room}`).then((({code:n,msg:a,data:{room_id:o,uid:i}})=>0===n?(t.room=parseInt(o),t.anchor=parseInt(i),!0):(e.push(a),!1))).catch((n=>(e.push("获取房间信息失败"+(s?"，请检查是否正确禁用了浏览器的 web security 以允许直接跨域":"")),e.push(String(n)),!1)));if(t.cookie){var o,i;const r=null===(o=/\bbuvid3=([^;]+)\b/.exec(t.cookie))||void 0===o?void 0:o[1],u=null===(i=/\bDedeUserID=([^;]+)\b/.exec(t.cookie))||void 0===i?void 0:i[1];r&&u&&await I(`https://api.live.bilibili.com/xlive/web-room/v1/index/getDanmuInfo?id=${t.room}&type=0`,{headers:{Cookie:t.cookie}}).then((async({code:o,message:i,data:{token:s,host_list:c}})=>{await n&&(0===o?a.value={address:`wss://${c[0].host}/sub`,authBody:{uid:parseInt(u),roomid:t.room,protover:3,buvid:r,platform:"web",type:2,key:s}}:e.push(i))})).catch((n=>{e.push("获取 token 失败"+(s?"，请检查是否正确禁用了浏览器的 web security 以允许直接跨域":"")),e.push(String(n))}))}await n,e.length?c.value=e.join("\n"):r.value=!0})(),t.debug&&import("https://fastly.jsdelivr.net/npm/vconsole/dist/vconsole.min.js").then((()=>{new window.VConsole})),{props:t,ready:r,errMsg:c,liveWsOptions:a}}});const $e=(0,je.Z)(Me,[["render",r]]);var Re=$e;(0,o.ri)(Re).mount("#app")}},n={};function t(a){var o=n[a];if(void 0!==o)return o.exports;var i=n[a]={id:a,loaded:!1,exports:{}};return e[a].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}t.m=e,function(){var e=[];t.O=function(n,a,o,i){if(!a){var s=1/0;for(l=0;l<e.length;l++){a=e[l][0],o=e[l][1],i=e[l][2];for(var r=!0,u=0;u<a.length;u++)(!1&i||s>=i)&&Object.keys(t.O).every((function(e){return t.O[e](a[u])}))?a.splice(u--,1):(r=!1,i<s&&(s=i));if(r){e.splice(l--,1);var c=o();void 0!==c&&(n=c)}}return n}i=i||0;for(var l=e.length;l>0&&e[l-1][2]>i;l--)e[l]=e[l-1];e[l]=[a,o,i]}}(),function(){t.n=function(e){var n=e&&e.__esModule?function(){return e["default"]}:function(){return e};return t.d(n,{a:n}),n}}(),function(){t.d=function(e,n){for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){t.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){var e={576:0};t.O.j=function(n){return 0===e[n]};var n=function(n,a){var o,i,s=a[0],r=a[1],u=a[2],c=0;if(s.some((function(n){return 0!==e[n]}))){for(o in r)t.o(r,o)&&(t.m[o]=r[o]);if(u)var l=u(t)}for(n&&n(a);c<s.length;c++)i=s[c],t.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return t.O(l)},a=self["webpackChunkbilibili_live_chat"]=self["webpackChunkbilibili_live_chat"]||[];a.forEach(n.bind(null,0)),a.push=n.bind(null,a.push.bind(a))}();var a=t.O(void 0,[64,639],(function(){return t(7494)}));a=t.O(a)})();